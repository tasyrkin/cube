<!DOCTYPE html>  <html>  <head>      <title>genSchema.coffee</title>      <meta http-equiv="content-type" content="text/html; charset=UTF-8">      <link rel="stylesheet" media="all" href="zocco.css" />  </head>  <body>      <div id="container">          <div id="background"></div>                        <div id="jumpWrapper">                  <div id="jumpPage">                      <label>Files...</label>                                                                  <a class="source" href="app.html">                          app.coffee                      </a>                                                                  <a class="source" href="collection.html">                          collection.coffee                      </a>                                                                  <a class="source" href="facets.html">                          facets.coffee                      </a>                                                                  <a class="source" href="index.html">                          index.coffee                      </a>                                                                  <a class="source" href="facetArray.html">                          facetArray.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="print.html">                          print.coffee                      </a>                                                                  <a class="source" href="routes.html">                          routes.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="profile.html">                          profile.coffee                      </a>                                                                  <a class="source" href="cube.html">                          cube.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="server.config.html">                          server.config.coffee                      </a>                                                                  <a class="source" href="server.routes.html">                          server.routes.coffee                      </a>                                                                  <a class="source" href="server.settings.html">                          server.settings.coffee                      </a>                                                                  <a class="source" href="entityController.html">                          entityController.coffee                      </a>                                                                  <a class="source" href="extensionController.html">                          extensionController.coffee                      </a>                                                                  <a class="source" href="facetManager.html">                          facetManager.coffee                      </a>                                                                  <a class="source" href="itemController.html">                          itemController.coffee                      </a>                                                                  <a class="source" href="printController.html">                          printController.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="solrManager.html">                          solrManager.coffee                      </a>                                                                  <a class="source" href="genSchema.html">                          genSchema.coffee                      </a>                                                                  <a class="source" href="importer-fortunes.html">                          importer-fortunes.coffee                      </a>                                                                  <a class="source" href="importer-hosts.html">                          importer-hosts.coffee                      </a>                                                                  <a class="source" href="importer-projects.html">                          importer-projects.coffee                      </a>                                        </div>              </div>                    <table cellpadding="0" cellspacing="0">              <thead>                  <tr>                      <th class="docs">                          <h1>                              genSchema.coffee                          </h1>                      </th>                      <th class="code">                      </th>                  </tr>              </thead>              <tbody>                                                      <tr id="section-1">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-1">&#182;</a>                          </div>                                                </td>                      <td class="code">                          <div class="highlight"><pre><span class="c1">#!/usr/bin/env coffee</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-2">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-2">&#182;</a>                          </div>                          <h3 id="solrschemagenerator">Solr Schema Generator</h3>

<p>Prepares the database to hold our items by generating an appropriate schema
XML file based on the application's schema.coffee</p>

<p>@autor Emanuel Lauria <a href="&#x6D;&#97;&#105;&#x6C;&#116;&#111;:&#x65;&#109;&#97;&#x6E;&#x75;&#101;&#108;&#x2E;&#x6C;&#97;&#x75;&#x72;i&#97;&#64;&#x7A;&#x61;&#x6C;&#97;&#x6E;&#x64;&#x6F;&#x2E;&#x64;&#x65;">&#x65;&#109;&#97;&#x6E;&#x75;&#101;&#108;&#x2E;&#x6C;&#97;&#x75;&#x72;i&#97;&#64;&#x7A;&#x61;&#x6C;&#97;&#x6E;&#x64;&#x6F;&#x2E;&#x64;&#x65;</a></p>                      </td>                      <td class="code">                          <div class="highlight"><pre><span class="nx">require</span> <span class="s">&#39;coffee-script&#39;</span>
<span class="nv">_       = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nv">fs      = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">async   = </span><span class="nx">require</span> <span class="s">&#39;async&#39;</span>

<span class="nv">root = </span><span class="s">&quot;./solr/solr/conf/&quot;</span>

<span class="nv">genSchemaForEntity = </span><span class="nf">(entity, cb) -&gt;</span>

    <span class="nv">schema  = </span><span class="nx">require</span> <span class="s">&quot;../extensions/</span><span class="si">#{</span><span class="nx">entity</span><span class="si">}</span><span class="s">/schema.coffee&quot;</span>
    <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">root</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">entity</span><span class="si">}</span><span class="s">/conf/schema.xml&quot;</span>

    <span class="nv">output = </span><span class="p">[]</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;?xml version=&quot;1.0&quot; ?&gt;&#39;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;schema name=&quot;team core&quot; version=&quot;1.1&quot;&gt;&#39;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;types&gt;&#39;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;  &lt;fieldtype name=&quot;string&quot; class=&quot;solr.StrField&quot;</span>
<span class="s"> sortMissingLast=&quot;true&quot; omitNorms=&quot;true&quot;/&gt;&#39;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;/types&gt;&#39;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;fields&gt;&#39;</span>

    <span class="nv">formField = </span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">field = </span><span class="p">[]</span>
        <span class="nv">id = </span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span>
        <span class="nv">mv = </span><span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">multivalue</span> <span class="k">then</span> <span class="kc">yes</span> <span class="k">else</span> <span class="kc">no</span>
        <span class="nv">req = </span><span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mandatory</span> <span class="k">then</span> <span class="kc">yes</span> <span class="k">else</span> <span class="kc">no</span>

        <span class="nx">field</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;  &lt;field&#39;</span>
        <span class="nx">field</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;name=\&quot;</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">\&quot; type=\&quot;string\&quot; indexed=\&quot;true\&quot;</span>
<span class="s"> stored=\&quot;true\&quot;&quot;</span>
        <span class="nx">field</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;multiValued=\&quot;</span><span class="si">#{</span><span class="nx">mv</span><span class="si">}</span><span class="s">\&quot; required=\&quot;</span><span class="si">#{</span><span class="nx">req</span><span class="si">}</span><span class="s">\&quot; /&gt;&quot;</span>
        <span class="k">return</span> <span class="nx">field</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39; &#39;</span>

    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">formField</span> <span class="nv">id: </span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nv">mandatory: </span><span class="kc">yes</span>

    <span class="nv">defaultSearchField = </span><span class="s">&#39;&#39;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">defaultSearchField</span><span class="p">,</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">defaultSearchField = </span><span class="nx">s</span><span class="p">[</span><span class="s">&#39;defaultSearchField&#39;</span><span class="p">]</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">schema</span><span class="p">,</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">formField</span> <span class="nx">s</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;/fields&gt;&#39;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;uniqueKey&gt;id&lt;/uniqueKey&gt;&#39;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;&lt;defaultSearchField&gt;</span><span class="si">#{</span><span class="nx">defaultSearchField</span><span class="si">}</span><span class="s">&lt;/defaultSearchField&gt;&quot;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;solrQueryParser defaultOperator=&quot;OR&quot;/&gt;&#39;</span>
    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&lt;/schema&gt;&#39;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">)</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">),</span> <span class="nf">(err) -&gt;</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;Failed to generate Schema. \n&#39;</span><span class="p">,</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">cb</span><span class="p">()</span>

<span class="nv">genSchemaForAll = </span><span class="nf">() -&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">root</span><span class="p">,</span> <span class="nf">(err, files) -&gt;</span>
        <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">files</span><span class="p">,</span>
            <span class="nf">(entity, cb) -&gt;</span>
                <span class="nx">genSchemaForEntity</span> <span class="nx">entity</span><span class="p">,</span> <span class="nf">() -&gt;</span>
                    <span class="nx">end</span> <span class="nx">entity</span>
                    <span class="nx">cb</span><span class="p">()</span>
          <span class="p">,</span>
            <span class="nf">() -&gt;</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;All Schemas generated.&quot;</span>

<span class="nv">end = </span><span class="nf">(entity) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;--- Schema for </span><span class="si">#{</span><span class="nx">entity</span><span class="si">}</span><span class="s"> app successfully created&quot;</span>

<span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">and</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;-p&#39;</span>
    <span class="k">return</span> <span class="nx">genSchemaForEntity</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nf">() -&gt;</span>
        <span class="nx">end</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="nx">genSchemaForAll</span><span class="p">()</span>

</pre></div>                      </td>                  </tr>                                </tbody>          </table>      </div>  </body>  </html>