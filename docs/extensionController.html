<!DOCTYPE html>  <html>  <head>      <title>extensionController.coffee</title>      <meta http-equiv="content-type" content="text/html; charset=UTF-8">      <link rel="stylesheet" media="all" href="zocco.css" />  </head>  <body>      <div id="container">          <div id="background"></div>                        <div id="jumpWrapper">                  <div id="jumpPage">                      <label>Files...</label>                                                                  <a class="source" href="app.html">                          app.coffee                      </a>                                                                  <a class="source" href="collection.html">                          collection.coffee                      </a>                                                                  <a class="source" href="facets.html">                          facets.coffee                      </a>                                                                  <a class="source" href="index.html">                          index.coffee                      </a>                                                                  <a class="source" href="facetArray.html">                          facetArray.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="print.html">                          print.coffee                      </a>                                                                  <a class="source" href="routes.html">                          routes.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="profile.html">                          profile.coffee                      </a>                                                                  <a class="source" href="cube.html">                          cube.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="server.config.html">                          server.config.coffee                      </a>                                                                  <a class="source" href="server.routes.html">                          server.routes.coffee                      </a>                                                                  <a class="source" href="server.settings.html">                          server.settings.coffee                      </a>                                                                  <a class="source" href="entityController.html">                          entityController.coffee                      </a>                                                                  <a class="source" href="extensionController.html">                          extensionController.coffee                      </a>                                                                  <a class="source" href="facetManager.html">                          facetManager.coffee                      </a>                                                                  <a class="source" href="itemController.html">                          itemController.coffee                      </a>                                                                  <a class="source" href="printController.html">                          printController.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="solrManager.html">                          solrManager.coffee                      </a>                                                                  <a class="source" href="genSchema.html">                          genSchema.coffee                      </a>                                                                  <a class="source" href="importer-fortunes.html">                          importer-fortunes.coffee                      </a>                                                                  <a class="source" href="importer-hosts.html">                          importer-hosts.coffee                      </a>                                                                  <a class="source" href="importer-projects.html">                          importer-projects.coffee                      </a>                                        </div>              </div>                    <table cellpadding="0" cellspacing="0">              <thead>                  <tr>                      <th class="docs">                          <h1>                              extensionController.coffee                          </h1>                      </th>                      <th class="code">                      </th>                  </tr>              </thead>              <tbody>                                                      <tr id="section-1">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-1">&#182;</a>                          </div>                          <h1 id="">#</h1>

<p>ExtensionController.coffee</p>

<p>@author: Emanuel Lauria <a href="&#109;&#x61;i&#108;&#116;&#x6F;:&#x65;&#x6D;&#x61;&#110;&#117;&#x65;&#108;&#x2E;&#x6C;&#x61;&#x75;&#114;&#105;&#x61;&#64;&#122;&#x61;l&#x61;&#110;&#x64;&#111;.&#x64;&#x65;">&#x65;&#x6D;&#x61;&#110;&#117;&#x65;&#108;&#x2E;&#x6C;&#x61;&#x75;&#114;&#105;&#x61;&#64;&#122;&#x61;l&#x61;&#110;&#x64;&#111;.&#x64;&#x65;</a></p>

<h1 id="">#</h1>                      </td>                      <td class="code">                          <div class="highlight"><pre><span class="nv">fs = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nv">mime = </span><span class="nx">require</span> <span class="s">&#39;mime-magic&#39;</span>
<span class="nv">http    = </span><span class="nx">require</span> <span class="s">&quot;http&quot;</span>
<span class="nv">async   = </span><span class="nx">require</span> <span class="s">&quot;async&quot;</span>
<span class="nv">exec    = </span><span class="nx">require</span><span class="p">(</span><span class="s">&quot;child_process&quot;</span><span class="p">).</span><span class="nx">exec</span>

<span class="nv">SolrManager = </span><span class="nx">require</span> <span class="s">&#39;./solrManager.coffee&#39;</span>
<span class="nv">ItemController = </span><span class="nx">require</span> <span class="s">&#39;./itemController.coffee&#39;</span>

<span class="nv">settings = </span><span class="nx">require</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../server.settings.coffee&quot;</span>
<span class="nv">entities = </span><span class="nx">require</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../entities.json&quot;</span>

<span class="nv">e = </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span>
<span class="nv">defaultDatabase = </span><span class="nx">settings</span><span class="p">.</span><span class="nx">Default</span><span class="p">.</span><span class="nx">Database</span><span class="p">.</span><span class="nx">development</span>
<span class="nv">defaultDatabase = </span><span class="nx">settings</span><span class="p">.</span><span class="nx">Default</span><span class="p">.</span><span class="nx">Database</span><span class="p">.</span><span class="nx">production</span> <span class="k">if</span> <span class="nx">e</span> <span class="o">is</span> <span class="s">&quot;production&quot;</span>
<span class="nv">defaultAppSettings = </span><span class="nx">settings</span><span class="p">.</span><span class="nx">Default</span><span class="p">.</span><span class="nx">Application</span>

<span class="k">class</span> <span class="nx">ExtensionController</span>
    <span class="nv">module.exports = </span><span class="nx">ExtensionController</span>

    <span class="nv">constructor: </span><span class="nf">(app) -&gt;</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">post</span>    <span class="s">&#39;/extension/:name&#39;</span><span class="p">,</span>     <span class="p">(</span><span class="nx">a</span><span class="p">...)</span>  <span class="o">=&gt;</span> <span class="nx">@create</span>  <span class="nx">a</span><span class="p">...</span>
        <span class="nx">app</span><span class="p">.</span><span class="k">delete</span>  <span class="s">&#39;/extension/:name&#39;</span><span class="p">,</span>     <span class="p">(</span><span class="nx">a</span><span class="p">...)</span>  <span class="o">=&gt;</span> <span class="nx">@</span><span class="k">delete</span>  <span class="nx">a</span><span class="p">...</span>

    <span class="nv">create: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">import</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">type = </span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">import</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">file = </span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">import</span><span class="p">.</span><span class="nx">path</span>
        <span class="nv">r = </span><span class="p">{}</span>

        <span class="nx">async</span><span class="p">.</span><span class="nx">series</span>
            <span class="nv">getMime: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">mime</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">(err, t) -&gt;</span>
                    <span class="nv">r.type = </span><span class="nx">t</span>
                    <span class="nx">cb</span><span class="p">()</span>

            <span class="nv">readFile: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span> <span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="nf">(err, d) -&gt;</span>
                    <span class="nv">r.data = </span><span class="nx">d</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

            <span class="nv">touchDirs: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@touchExtensionDir</span> <span class="nx">name</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

            <span class="nv">createCore: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
                <span class="nx">@createCore</span> <span class="nx">name</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

            <span class="nv">generateSchema: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">if</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="s">&quot;./extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/schema.json&quot;</span><span class="p">,</span> <span class="s">&quot;utf8&quot;</span><span class="p">,</span>
                        <span class="nf">(err, s) -&gt;</span>
                            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                            <span class="nv">r.schema = </span><span class="nx">s</span>
                            <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>
                <span class="k">else</span>
                    <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;csv&quot;</span>
                        <span class="nv">ids = </span><span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="nv">ids = </span><span class="p">[]</span>
                        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span> <span class="nf">(item) -&gt;</span>
                            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">item</span><span class="p">,</span> <span class="nf">(value, key) -&gt;</span>
                                <span class="nx">ids</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span> <span class="k">if</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="nx">@generateSchema</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ids</span><span class="p">,</span> <span class="nf">(s) -&gt;</span>
                        <span class="nv">r.schema = </span><span class="nx">s</span>
                        <span class="nx">cb</span><span class="p">()</span>

            <span class="nv">importData: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;csv&#39;</span>
                    <span class="k">return</span> <span class="nx">@importFromCSV</span> <span class="nx">r</span><span class="p">.</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                        <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">@importFromJson</span> <span class="nx">r</span><span class="p">.</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

            <span class="nv">saveFile: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
                <span class="nx">entities</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span>
                <span class="nx">@saveJsonToFile</span> <span class="nx">entities</span><span class="p">,</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">EntitiesFile</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

            <span class="nv">setResponse: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">(err, stats) -&gt;</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span>
                        <span class="s">&#39;text/plain; charset=utf8&#39;</span>
                    <span class="nv">r.response = </span><span class="p">[</span>
                        <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="nx">name</span> <span class="o">+</span> <span class="s">&#39;.csv&#39;</span>
                        <span class="s">&quot;size&quot;</span><span class="o">:</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">size</span>
                        <span class="s">&quot;type&quot;</span><span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">type</span>
                    <span class="p">]</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

            <span class="nv">removeTmpFile: </span><span class="nf">(cb) -&gt;</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span> <span class="nx">file</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">,</span>
            <span class="nf">(result) -&gt;</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">r</span><span class="p">.</span><span class="nx">response</span>

    <span class="k">delete</span><span class="o">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span>
        <span class="nv">child = </span><span class="nx">exec</span> <span class="s">&quot;rm -rf extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s"> public/images/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                <span class="nv">es = </span><span class="p">[]</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">entities</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
                    <span class="k">return</span> <span class="k">if</span> <span class="nx">e</span> <span class="o">is</span> <span class="nx">name</span>
                    <span class="nx">es</span><span class="p">.</span><span class="nx">push</span> <span class="nx">e</span>
                <span class="nv">entities = </span><span class="nx">es</span>
                <span class="nx">@saveJsonToFile</span> <span class="nx">entities</span><span class="p">,</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">EntitiesFile</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
                    <span class="nx">@removeCore</span> <span class="nx">name</span><span class="p">,</span> <span class="nf">() -&gt;</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="s">&#39;Extension successfully removed&#39;</span>

    <span class="nv">failedCreatingExtension: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;Failed creating extension: &#39;</span><span class="p">,</span> <span class="nx">name</span>
        <span class="nx">@</span><span class="k">delete</span> <span class="nf">() -&gt;</span>
            <span class="k">throw</span> <span class="nx">err</span>

    <span class="nv">generateSchema: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">ids</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">schema = </span><span class="p">[]</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">ids</span><span class="p">,</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">return</span> <span class="k">if</span> <span class="nx">id</span> <span class="o">is</span> <span class="s">&#39;id&#39;</span>
            <span class="nx">schema</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@createSchemaField</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#39;string&#39;</span>
        <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/schema.json&quot;</span>
        <span class="nx">@saveJsonToFile</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nf">() -&gt;</span>
            <span class="nx">cb</span> <span class="nx">schema</span>

    <span class="nv">touchExtensionDir: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">archivePath = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../public/images/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/archive/&quot;</span>
        <span class="nv">child = </span><span class="nx">exec</span> <span class="s">&quot;mkdir -p </span><span class="si">#{</span><span class="nx">archivePath</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nv">extPath = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">child = </span><span class="nx">exec</span> <span class="s">&quot;mkdir -p </span><span class="si">#{</span><span class="nx">extPath</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="p">[</span> <span class="s">&#39;code.coffee&#39;</span><span class="p">,</span> <span class="s">&#39;style.styl&#39;</span><span class="p">,</span> <span class="s">&#39;templates.jade&#39;</span> <span class="p">],</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nv">child = </span><span class="nx">exec</span> <span class="s">&quot;touch extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">file</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
                    <span class="nx">failedCreatingExtension</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">@touchDBSettingsFile</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
            <span class="nx">@touchAppSettingsFile</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
            <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">if</span> <span class="nx">cb</span>

    <span class="nv">importFromJson: </span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">jsonarr</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">jsonarr = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">jsonarr</span>
        <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">jsonarr</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">_cb</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">e = </span><span class="nx">removeSuffix</span> <span class="nx">e</span>
            <span class="nv">id = </span><span class="nx">@generateId</span><span class="p">()</span>

            <span class="nv">solrManager = </span><span class="k">new</span> <span class="nx">SolrManager</span> <span class="nx">name</span>
            <span class="nx">solrManager</span><span class="p">.</span><span class="nx">createSolrClient</span> <span class="nx">name</span>

            <span class="nv">newItem = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">id</span><span class="p">},</span> <span class="nx">solrManager</span><span class="p">.</span><span class="nx">addObjSuffix</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">e</span>

            <span class="nx">solrManager</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">add</span> <span class="p">[</span><span class="nx">newItem</span><span class="p">],</span> <span class="nf">(err, result) -&gt;</span>
                <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                <span class="nx">_cb</span><span class="p">()</span>
        <span class="p">,</span>
            <span class="nf">(err) -&gt;</span>
                <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">cb</span>

    <span class="nv">importFromCSV: </span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">csv</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">lines = </span><span class="nx">csv</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">)</span>
        <span class="nv">ids = </span><span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">_cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">return</span> <span class="nx">_cb</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">l</span>
                <span class="nv">item = </span><span class="p">{}</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">l</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span>
                    <span class="k">return</span> <span class="nx">_cb</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">v</span>
                    <span class="nx">item</span><span class="p">[</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">v</span>
                    <span class="nv">field = </span><span class="nx">@getFieldFromSchema</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nx">field</span><span class="p">.</span><span class="nx">multivalue</span>
                        <span class="nx">item</span><span class="p">[</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

                <span class="nv">id = </span><span class="nx">@generateId</span><span class="p">()</span>

                <span class="nv">solrManager = </span><span class="k">new</span> <span class="nx">SolrManager</span> <span class="nx">name</span>
                <span class="nx">solrManager</span><span class="p">.</span><span class="nx">createClient</span><span class="p">()</span>

                <span class="nv">item = </span><span class="nx">solrManager</span><span class="p">.</span><span class="nx">addObjSuffix</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
                <span class="nv">newItem = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">id</span><span class="p">},</span> <span class="nx">item</span>

                <span class="nx">solrManager</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">add</span> <span class="p">[</span><span class="nx">newItem</span><span class="p">],</span> <span class="nf">(err, result) -&gt;</span>
                    <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                    <span class="nx">_cb</span><span class="p">()</span>
        <span class="p">,</span>
            <span class="nf">(err) -&gt;</span>
                <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">cb</span>

    <span class="nv">createCore: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">solrPath = </span><span class="nx">defaultDatabase</span><span class="p">.</span><span class="nx">path</span>
        <span class="nv">dataRoot = </span><span class="nx">defaultDatabase</span><span class="p">.</span><span class="nx">dataRoot</span>
        <span class="nv">dataDir = </span><span class="s">&quot;/data/zalando/app/</span><span class="si">#{</span><span class="nx">dataRoot</span><span class="si">}</span><span class="s">/solr/data/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/&quot;</span>
        <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">solrPath</span><span class="si">}</span><span class="s">/admin/cores?action=CREATE&quot;</span>
        <span class="nx">path</span> <span class="o">+=</span> <span class="s">&quot;&amp;name=</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">path</span> <span class="o">+=</span> <span class="s">&quot;&amp;instanceDir=conf/cube&quot;</span>
        <span class="nx">path</span> <span class="o">+=</span> <span class="s">&quot;&amp;dataDir=</span><span class="si">#{</span><span class="nx">dataDir</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">db = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">defaultDatabase</span>
        <span class="nv">db.path = </span><span class="nx">path</span>

        <span class="nv">req = </span><span class="nx">http</span><span class="p">.</span><span class="nx">request</span> <span class="nx">db</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s">&#39;utf8&#39;</span>
            <span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">cb</span>

        <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;Failed creating core with error:&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span>

        <span class="nx">req</span><span class="p">.</span><span class="nx">write</span> <span class="s">&#39;data\n&#39;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">write</span> <span class="s">&#39;data\n&#39;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

    <span class="nv">removeCore: </span><span class="nf">(name, cb) -&gt;</span>
        <span class="nv">solrPath = </span><span class="nx">defaultDatabase</span><span class="p">.</span><span class="nx">path</span>
        <span class="nv">path = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">solrPath</span><span class="si">}</span><span class="s">/admin/cores?action=UNLOAD&quot;</span>
        <span class="nx">path</span> <span class="o">+=</span> <span class="s">&quot;&amp;core=</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">path</span> <span class="o">+=</span> <span class="s">&quot;&amp;deleteIndex=true&quot;</span>
        <span class="nv">db = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">defaultDatabase</span>
        <span class="nv">db.path = </span><span class="nx">path</span>

        <span class="nv">req = </span><span class="nx">http</span><span class="p">.</span><span class="nx">request</span> <span class="nx">db</span><span class="p">,</span> <span class="nf">(res) -&gt;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s">&#39;utf8&#39;</span>
            <span class="nx">res</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
                <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">cb</span>

        <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;Failed removing core with error:&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span>

        <span class="nx">req</span><span class="p">.</span><span class="nx">write</span> <span class="s">&#39;data\n&#39;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">write</span> <span class="s">&#39;data\n&#39;</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

    <span class="nv">saveJsonToFile: </span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="nf">(err) -&gt;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;Error writing file&#39;</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">cb</span>

    <span class="nv">touchDBSettingsFile: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">db = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">defaultDatabase</span>
        <span class="nv">db.core = </span><span class="nx">name</span>
        <span class="nx">@saveJsonToFile</span> <span class="nx">db</span><span class="p">,</span> <span class="s">&quot;extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/db.json&quot;</span><span class="p">,</span> <span class="nx">cb</span>

    <span class="nv">touchAppSettingsFile: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">appSettings = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">defaultAppSettings</span>
        <span class="nv">appSettings.entity = </span><span class="nx">name</span>
        <span class="nv">appSettings.title = </span><span class="nx">name</span>
        <span class="nx">@saveJsonToFile</span> <span class="nx">appSettings</span><span class="p">,</span> <span class="s">&quot;extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/settings.json&quot;</span><span class="p">,</span> <span class="nx">cb</span>

    <span class="nv">createSchemaField: </span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">suffix = </span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">id = </span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">field = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">Default</span><span class="p">.</span><span class="nx">SchemaField</span>
        <span class="nv">field.id = </span><span class="nx">id</span>
        <span class="nv">field.label = </span><span class="nx">id</span>

        <span class="k">return</span> <span class="nx">field</span> <span class="nx">unless</span> <span class="nx">suffix</span>
        <span class="nv">field.type = </span><span class="nx">settings</span><span class="p">.</span><span class="nx">Default</span><span class="p">.</span><span class="nx">Suffix</span><span class="p">[</span><span class="nx">suffix</span><span class="p">]</span>
        <span class="nx">field</span>

    <span class="nv">getFieldFromSchema: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">schema = </span><span class="nx">require</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/schema.json&quot;</span>
        <span class="nv">field = </span><span class="p">{}</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">schema</span><span class="p">,</span> <span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">id</span>
                <span class="nv">field = </span><span class="nx">o</span>
        <span class="nx">field</span>

    <span class="nv">generateId: </span><span class="nf">() -&gt;</span>
        <span class="nv">chars = </span><span class="s">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span>
        <span class="nv">today = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
        <span class="nv">result = </span><span class="nx">today</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">().</span><span class="nx">toString</span> <span class="mi">16</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">substr</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span> <span class="mi">1</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">substr</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">chars</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span> <span class="mi">1</span>
        <span class="nx">result</span>

</pre></div>                      </td>                  </tr>                                </tbody>          </table>      </div>  </body>  </html>