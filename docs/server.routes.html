<!DOCTYPE html>  <html>  <head>      <title>server.routes.coffee</title>      <meta http-equiv="content-type" content="text/html; charset=UTF-8">      <link rel="stylesheet" media="all" href="zocco.css" />  </head>  <body>      <div id="container">          <div id="background"></div>                        <div id="jumpWrapper">                  <div id="jumpPage">                      <label>Files...</label>                                                                  <a class="source" href="app.html">                          app.coffee                      </a>                                                                  <a class="source" href="collection.html">                          collection.coffee                      </a>                                                                  <a class="source" href="facets.html">                          facets.coffee                      </a>                                                                  <a class="source" href="index.html">                          index.coffee                      </a>                                                                  <a class="source" href="facetArray.html">                          facetArray.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="print.html">                          print.coffee                      </a>                                                                  <a class="source" href="routes.html">                          routes.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="profile.html">                          profile.coffee                      </a>                                                                  <a class="source" href="cube.html">                          cube.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="server.config.html">                          server.config.coffee                      </a>                                                                  <a class="source" href="server.routes.html">                          server.routes.coffee                      </a>                                                                  <a class="source" href="server.settings.html">                          server.settings.coffee                      </a>                                                                  <a class="source" href="entityController.html">                          entityController.coffee                      </a>                                                                  <a class="source" href="extensionController.html">                          extensionController.coffee                      </a>                                                                  <a class="source" href="facetManager.html">                          facetManager.coffee                      </a>                                                                  <a class="source" href="itemController.html">                          itemController.coffee                      </a>                                                                  <a class="source" href="printController.html">                          printController.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="solrManager.html">                          solrManager.coffee                      </a>                                                                  <a class="source" href="genSchema.html">                          genSchema.coffee                      </a>                                                                  <a class="source" href="importer-fortunes.html">                          importer-fortunes.coffee                      </a>                                                                  <a class="source" href="importer-hosts.html">                          importer-hosts.coffee                      </a>                                                                  <a class="source" href="importer-projects.html">                          importer-projects.coffee                      </a>                                        </div>              </div>                    <table cellpadding="0" cellspacing="0">              <thead>                  <tr>                      <th class="docs">                          <h1>                              server.routes.coffee                          </h1>                      </th>                      <th class="code">                      </th>                  </tr>              </thead>              <tbody>                                                      <tr id="section-1">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-1">&#182;</a>                          </div>                          <h2 id="">#</h2>

<p>Cube Nodejs routes
server.routes.coffee</p>

<p>@author: Emanuel Lauria <a href="&#109;a&#105;&#x6C;&#116;&#111;:&#x65;&#109;&#97;&#x6E;&#117;&#101;&#x6C;&#46;&#x6C;&#97;&#x75;&#x72;&#105;&#x61;&#64;z&#x61;&#108;&#x61;&#x6E;&#x64;&#x6F;&#46;&#x64;e">&#x65;&#109;&#97;&#x6E;&#117;&#101;&#x6C;&#46;&#x6C;&#97;&#x75;&#x72;&#105;&#x61;&#64;z&#x61;&#108;&#x61;&#x6E;&#x64;&#x6F;&#46;&#x64;e</a></p>

<h2 id="">#</h2>                      </td>                      <td class="code">                          <div class="highlight"><pre><span class="nv">module.exports = </span><span class="nf">(app, express) -&gt;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-2">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-2">&#182;</a>                          </div>                          <h3 id="requirements">Requirements</h3>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">async   = </span><span class="nx">require</span> <span class="s">&quot;async&quot;</span>
    <span class="nv">fs      = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>
    <span class="nv">_       = </span><span class="nx">require</span> <span class="s">&quot;underscore&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-3">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-3">&#182;</a>                          </div>                          <p>Server and default extension settings</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">settings = </span><span class="nx">require</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/server.settings.coffee&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-4">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-4">&#182;</a>                          </div>                          <p>List of available entities</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">entities = </span><span class="nx">require</span> <span class="s">&quot;./</span><span class="si">#{</span><span class="nx">settings</span><span class="p">.</span><span class="nx">EntitiesFile</span><span class="si">}</span><span class="s">&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-5">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-5">&#182;</a>                          </div>                          <p>Controllers</p>                      </td>                      <td class="code">                          <div class="highlight"><pre></pre></div>                      </td>                  </tr>                                                      <tr id="section-6">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-6">&#182;</a>                          </div>                          <p>Serves any request about entities, like getting its collection</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">EntityController    = </span><span class="nx">require</span> <span class="s">&quot;./server/entityController.coffee&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-7">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-7">&#182;</a>                          </div>                          <p>Serves any request about an item, like querying by ID.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">ItemController      = </span><span class="nx">require</span> <span class="s">&quot;./server/itemController.coffee&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-8">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-8">&#182;</a>                          </div>                          <p>Servers any request about extension administration, like creating one.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">ExtensionController = </span><span class="nx">require</span> <span class="s">&quot;./server/extensionController.coffee&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-9">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-9">&#182;</a>                          </div>                          <p>Servers any request about the print view, like showing items for print.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">PrintController     = </span><span class="nx">require</span> <span class="s">&quot;./server/printController.coffee&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-10">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-10">&#182;</a>                          </div>                          <p>Create instances from controllers</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="k">new</span> <span class="nx">EntityController</span>    <span class="nx">app</span>
    <span class="k">new</span> <span class="nx">ItemController</span>      <span class="nx">app</span>
    <span class="k">new</span> <span class="nx">ExtensionController</span> <span class="nx">app</span>
    <span class="k">new</span> <span class="nx">PrintController</span>     <span class="nx">app</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-11">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-11">&#182;</a>                          </div>                          <p>Default entity is the first entity defined in the entities array</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">defaultEntity = </span><span class="nx">entities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-12">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-12">&#182;</a>                          </div>                          <h3 id="routes">Routes</h3>                      </td>                      <td class="code">                          <div class="highlight"><pre></pre></div>                      </td>                  </tr>                                                      <tr id="section-13">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-13">&#182;</a>                          </div>                          <p>Root route</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/&#39;</span><span class="p">,</span>        <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">root</span> <span class="nx">a</span><span class="p">...</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-14">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-14">&#182;</a>                          </div>                          <p>Entity route</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/:entity&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">entity</span> <span class="nx">a</span><span class="p">...</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-15">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-15">&#182;</a>                          </div>                          <h3 id="functionality">Functionality</h3>                      </td>                      <td class="code">                          <div class="highlight"><pre></pre></div>                      </td>                  </tr>                                                      <tr id="section-16">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-16">&#182;</a>                          </div>                          <p>Serves request to '/'. Redirection to default host if the request
is coming from an old/deprectaed URL.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">root = </span> <span class="nf">(req, res) -&gt;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-17">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-17">&#182;</a>                          </div>                          <p>Redirect to default host if coming from old host</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">redirectToDefaultHost</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="k">if</span> <span class="nx">isOldHost</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-18">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-18">&#182;</a>                          </div>                          <p>Req is fine, get available entities and render index page.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="nx">getEntities</span> <span class="p">(</span><span class="nx">es</span><span class="p">)</span> <span class="o">=&gt;</span>

            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span> <span class="s">&#39;index&#39;</span><span class="p">,</span> <span class="nv">entities: </span><span class="nx">es</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-19">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-19">&#182;</a>                          </div>                          <p>Serves an entity rendering the app with the appropriate collection. It
also redirects to a default entity in case of misunderstandings.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">entity = </span><span class="nf">(req, res) -&gt;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-20">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-20">&#182;</a>                          </div>                          <p>TODO This is not generic</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">redirectToDefaultHost</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="k">if</span> <span class="nx">isOldHost</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-21">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-21">&#182;</a>                          </div>                          <p>Entity request from the client</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="nv">e = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-22">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-22">&#182;</a>                          </div>                          <p>URL used by the client</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="nv">u = </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-23">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-23">&#182;</a>                          </div>                          <p>Redirect to /path/. The app requires a URL ending with / to
fetch static files correctly. Otherwise the backbone app will
append its routes to "path" instead of absolute routing "/".</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s">&quot;/</span><span class="si">#{</span><span class="nx">e</span><span class="si">}</span><span class="s">/&quot;</span> <span class="nx">unless</span> <span class="nx">u</span><span class="p">[</span><span class="nx">u</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;/&#39;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-24">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-24">&#182;</a>                          </div>                          <p>Render the index page if e is a valid entity</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">renderApp</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="k">if</span> <span class="nx">isEntity</span> <span class="nx">e</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-25">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-25">&#182;</a>                          </div>                          <p>Response 'ok' for status (NAGIOS)</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">e</span> <span class="o">is</span> <span class="s">&#39;status&#39;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-26">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-26">&#182;</a>                          </div>                          <p>Return list of entities</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">e</span> <span class="o">is</span> <span class="s">&#39;entities&#39;</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">getEntities</span> <span class="nf">(e) -&gt;</span>

            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">e</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-27">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-27">&#182;</a>                          </div>                          <p>Redirect to default app in any other case</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">redirectToDefault</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-28">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-28">&#182;</a>                          </div>                          <p>Default redirection to the default entity app</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">redirectToDefault = </span><span class="nf">(req, res) -&gt;</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s">&quot;/</span><span class="si">#{</span><span class="nx">defaultEntity</span><span class="si">}</span><span class="s">/&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-29">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-29">&#182;</a>                          </div>                          <p>Redirect the client to the correct domain and entity for the team app.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">redirectToDefaultHost = </span><span class="nf">(req, res) -&gt;</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s">&quot;http://</span><span class="si">#{</span><span class="nx">settings</span><span class="p">.</span><span class="nx">Web</span><span class="p">.</span><span class="nx">defaultHost</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">defaultEntity</span><span class="si">}</span><span class="s">/&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-30">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-30">&#182;</a>                          </div>                          <p>Render main cube backbone app</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">renderApp = </span><span class="nf">(req, res) -&gt;</span>

        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span>

        <span class="nv">params = </span> <span class="nv">entity: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">entities: </span><span class="nx">entities</span>

        <span class="nx">async</span><span class="p">.</span><span class="nx">parallel</span> <span class="p">[</span>

            <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">getJsonFile</span> <span class="s">&#39;settings.json&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="o">=&gt;</span>
                    <span class="nv">params.settings = </span><span class="nx">settings</span>
                    <span class="nx">cb</span><span class="p">()</span>

            <span class="p">,(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">getJsonFile</span> <span class="s">&#39;pane.json&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">pdata</span><span class="p">)</span> <span class="o">=&gt;</span>
                    <span class="nv">params.pdata = </span><span class="nx">pdata</span>
                    <span class="nx">cb</span><span class="p">()</span>

            <span class="p">,(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">getJsonFile</span> <span class="s">&#39;etiquettes.json&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">etiquettes</span><span class="p">)</span> <span class="o">=&gt;</span>
                    <span class="nv">params.etiquettes = </span><span class="nx">etiquettes</span>
                    <span class="nx">cb</span><span class="p">()</span>

            <span class="p">,(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">getJsonFile</span> <span class="s">&#39;schema.json&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">schema</span><span class="p">)</span> <span class="o">=&gt;</span>
                    <span class="nv">params.schema = </span><span class="nx">schema</span>
                    <span class="nx">cb</span><span class="p">()</span>

        <span class="p">],</span> <span class="p">()</span> <span class="o">=&gt;</span>

            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span> <span class="s">&#39;app&#39;</span><span class="p">,</span> <span class="nx">params</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-31">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-31">&#182;</a>                          </div>                          <p>Read a file and parse it as json, return a json object.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">getJsonFile = </span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>

        <span class="nv">f = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/extensions/</span><span class="si">#{</span><span class="nx">entity</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">file</span><span class="si">}</span><span class="s">&quot;</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">f</span><span class="p">,</span> <span class="s">&quot;utf8&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">return</span> <span class="nx">cb</span><span class="p">({})</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">cb</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-32">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-32">&#182;</a>                          </div>                          <p>Return templates from an extension</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">getTemplates = </span><span class="nf">(req, res, cb) -&gt;</span>

        <span class="nv">file = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/extensions/</span><span class="si">#{</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span><span class="si">}</span><span class="s">/templates&quot;</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span> <span class="nx">file</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">html</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">cb</span> <span class="nv">templates: </span><span class="nx">html</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-33">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-33">&#182;</a>                          </div>                          <p>Get all available entities along with their settings</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">getEntities = </span><span class="nf">(cb) -&gt;</span>

        <span class="nv">eFile = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">settings</span><span class="p">.</span><span class="nx">EntitiesFile</span><span class="si">}</span><span class="s">&quot;</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">eFile</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nv">entities = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">d</span>
            <span class="nv">es = </span><span class="p">[]</span>

            <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">entities</span><span class="p">,</span>

                <span class="nf">(e, cb) -&gt;</span>
                    <span class="nx">getJsonFile</span> <span class="s">&#39;settings.json&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nf">(s) -&gt;</span>
                        <span class="nx">es</span><span class="p">.</span><span class="nx">push</span> <span class="nx">s</span>
                        <span class="nx">cb</span><span class="p">()</span>

                <span class="p">,</span><span class="nf">(err) -&gt;</span>
                    <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                    <span class="nv">es = </span><span class="nx">sortEntities</span> <span class="nx">es</span><span class="p">,</span> <span class="nx">entities</span>
                    <span class="k">return</span> <span class="nx">cb</span> <span class="nx">es</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-34">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-34">&#182;</a>                          </div>                          <p>Sort entity names based on a predefined order</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">sortEntities = </span><span class="p">(</span><span class="nx">entities</span><span class="p">,</span> <span class="nx">orderedNames</span><span class="p">)</span> <span class="o">=&gt;</span>

        <span class="nv">ordered = </span><span class="p">[]</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">orderedNames</span><span class="p">,</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">entities</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">entity</span> <span class="o">is</span> <span class="nx">name</span>
                    <span class="nx">ordered</span><span class="p">.</span><span class="nx">push</span> <span class="nx">e</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">entities</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">orderedNames</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">entity</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">ordered</span><span class="p">.</span><span class="nx">push</span> <span class="nx">e</span>

        <span class="k">return</span> <span class="nx">ordered</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-35">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-35">&#182;</a>                          </div>                          <p>Check if client accesses the old team.zalando.net</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">isOldHost = </span><span class="nf">(req) -&gt;</span>

        <span class="nx">req</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s">&#39;host&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&#39;team.zalando.net&#39;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-36">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-36">&#182;</a>                          </div>                          <p>Return bool if e is in the entities array from the settings</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">isEntity = </span><span class="nf">(e) -&gt;</span>

        <span class="k">return</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>

</pre></div>                      </td>                  </tr>                                </tbody>          </table>      </div>  </body>  </html>