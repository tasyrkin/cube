<!DOCTYPE html>  <html>  <head>      <title>facets.coffee</title>      <meta http-equiv="content-type" content="text/html; charset=UTF-8">      <link rel="stylesheet" media="all" href="zocco.css" />  </head>  <body>      <div id="container">          <div id="background"></div>                        <div id="jumpWrapper">                  <div id="jumpPage">                      <label>Files...</label>                                                                  <a class="source" href="app.html">                          app.coffee                      </a>                                                                  <a class="source" href="collection.html">                          collection.coffee                      </a>                                                                  <a class="source" href="facets.html">                          facets.coffee                      </a>                                                                  <a class="source" href="index.html">                          index.coffee                      </a>                                                                  <a class="source" href="facetArray.html">                          facetArray.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="print.html">                          print.coffee                      </a>                                                                  <a class="source" href="routes.html">                          routes.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="profile.html">                          profile.coffee                      </a>                                                                  <a class="source" href="cube.html">                          cube.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="server.config.html">                          server.config.coffee                      </a>                                                                  <a class="source" href="server.routes.html">                          server.routes.coffee                      </a>                                                                  <a class="source" href="server.settings.html">                          server.settings.coffee                      </a>                                                                  <a class="source" href="entityController.html">                          entityController.coffee                      </a>                                                                  <a class="source" href="extensionController.html">                          extensionController.coffee                      </a>                                                                  <a class="source" href="facetManager.html">                          facetManager.coffee                      </a>                                                                  <a class="source" href="itemController.html">                          itemController.coffee                      </a>                                                                  <a class="source" href="printController.html">                          printController.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="solrManager.html">                          solrManager.coffee                      </a>                                                                  <a class="source" href="genSchema.html">                          genSchema.coffee                      </a>                                                                  <a class="source" href="importer-fortunes.html">                          importer-fortunes.coffee                      </a>                                                                  <a class="source" href="importer-hosts.html">                          importer-hosts.coffee                      </a>                                                                  <a class="source" href="importer-projects.html">                          importer-projects.coffee                      </a>                                        </div>              </div>                    <table cellpadding="0" cellspacing="0">              <thead>                  <tr>                      <th class="docs">                          <h1>                              facets.coffee                          </h1>                      </th>                      <th class="code">                      </th>                  </tr>              </thead>              <tbody>                                                      <tr id="section-1">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-1">&#182;</a>                          </div>                          <h3 id="facetcollection">Facet Collection</h3>                      </td>                      <td class="code">                          <div class="highlight"><pre><span class="k">class</span> <span class="nx">@Facets</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-2">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-2">&#182;</a>                          </div>                          <p>Contains facet objects ( { cat: category, field: name })</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">model: </span><span class="nb">window</span><span class="p">.</span><span class="nx">Facet</span><span class="p">,</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-3">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-3">&#182;</a>                          </div>                          <p>URL from QS
As for the items collection, the facet collection needs to get the
querystring parameters that will be used by solr.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">url: </span><span class="p">()</span> <span class="o">=&gt;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">commonURL</span><span class="p">()</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-4">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-4">&#182;</a>                          </div>                          <h3 id="parse">Parse</h3>

<ol>
<li>Get special fields from the schema (the ones that should go below
the horizontal line on the facet area)</li>
<li>Create an empty facet object of the described form.</li>
<li>Initialize normal and special facet objects arrays containers</li>
<li>Go through the solr response and push facet objects into their
appropriate normal/special arrays.</li>
<li>Since the facet response from solr is very weird ( its an array of
facet name followed by the amount number, followed by the next facet...
i.e. [ 'pizzas', 3, 'pastas', 5, 'desserts', 2], we parse it into a
cleaner json object.</li>
<li>For undefined fields (null) add them as 'not set'</li>
</ol>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">parse: </span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">s = </span><span class="nb">window</span><span class="p">.</span><span class="nx">Settings</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">getSpecials</span><span class="p">()</span>
        <span class="nv">facetFields = </span><span class="p">[]</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">res</span><span class="p">.</span><span class="nx">facet_counts</span><span class="o">?</span><span class="p">.</span><span class="nx">facet_fields</span><span class="p">,</span> <span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">name = </span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">Settings</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">getField</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">facetFields</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@createFacet</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span>
        <span class="nx">facetFields</span>

    <span class="nv">createFacet: </span><span class="p">(</span><span class="nx">facetName</span><span class="p">,</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="o">=&gt;</span>

        <span class="nv">facetName = </span><span class="nx">field</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">facetLabel = </span><span class="nx">field</span><span class="p">.</span><span class="nx">label</span>

        <span class="nv">sep = </span><span class="nx">field</span><span class="p">.</span><span class="nx">separator</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Settings</span><span class="p">.</span><span class="nx">separator</span>

        <span class="nv">normal = </span><span class="p">[]</span>
        <span class="nv">special = </span><span class="p">[]</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">fields</span><span class="p">,</span> <span class="p">(</span><span class="nx">field</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">return</span> <span class="nx">unless</span> <span class="nx">i</span><span class="o">%</span> <span class="mi">2</span> <span class="o">is</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="k">if</span> <span class="nx">field</span> <span class="o">is</span> <span class="kc">null</span>
            <span class="k">return</span> <span class="nx">special</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@isSpecial</span> <span class="nx">facetName</span><span class="p">,</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">sep</span>
            <span class="nx">normal</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span>

        <span class="nx">normal</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span>
        <span class="nx">special</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span>

        <span class="nx">normal</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;null&quot;</span>

        <span class="nv">root =</span>
            <span class="nv">name: </span><span class="nx">facetName</span>
            <span class="nv">label: </span><span class="nx">facetLabel</span>
            <span class="nv">fields:</span>
                <span class="nv">normal: </span><span class="p">{},</span>
                <span class="nv">special: </span><span class="p">{}</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">normal</span><span class="p">,</span> <span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">tree = </span><span class="nx">root</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">normal</span>
            <span class="nx">@createNode</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="nx">tree</span><span class="p">,</span> <span class="nx">sep</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">special</span><span class="p">,</span> <span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">tree = </span><span class="nx">root</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">special</span>
            <span class="nx">@createNode</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="nx">tree</span><span class="p">,</span> <span class="nx">sep</span>

        <span class="nx">root</span>

    <span class="nv">createNode: </span><span class="p">(</span><span class="nx">field</span><span class="p">,</span> <span class="nx">amounts</span><span class="p">,</span> <span class="nx">tree</span><span class="p">,</span> <span class="nx">sep</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">tokens = </span><span class="nx">field</span><span class="p">.</span><span class="nx">split</span> <span class="nx">sep</span>
        <span class="nv">name = </span><span class="nx">tokens</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">tokens</span><span class="p">,</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">tree = </span><span class="nx">tree</span><span class="p">[</span><span class="nx">token</span><span class="p">].</span><span class="nx">subs</span> <span class="k">if</span> <span class="nx">tree</span><span class="p">[</span><span class="nx">token</span><span class="p">]</span>
        <span class="nv">path = </span><span class="k">if</span> <span class="nx">name</span> <span class="o">is</span> <span class="s">&quot;null&quot;</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="nx">field</span>
        <span class="nx">tree</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span>
            <span class="nv">amount: </span><span class="nx">amounts</span><span class="p">[</span><span class="nx">amounts</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
            <span class="nv">path: </span><span class="nx">field</span>
            <span class="nv">subs: </span><span class="p">{}</span>

    <span class="nv">isSpecial: </span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">sep</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">parent = </span><span class="nx">field</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">specials = </span><span class="nb">window</span><span class="p">.</span><span class="nx">Settings</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">getSpecials</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">no</span> <span class="nx">unless</span> <span class="nx">specials</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">specials</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="kc">no</span>

</pre></div>                      </td>                  </tr>                                </tbody>          </table>      </div>  </body>  </html>