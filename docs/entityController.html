<!DOCTYPE html>  <html>  <head>      <title>entityController.coffee</title>      <meta http-equiv="content-type" content="text/html; charset=UTF-8">      <link rel="stylesheet" media="all" href="zocco.css" />  </head>  <body>      <div id="container">          <div id="background"></div>                        <div id="jumpWrapper">                  <div id="jumpPage">                      <label>Files...</label>                                                                  <a class="source" href="app.html">                          app.coffee                      </a>                                                                  <a class="source" href="collection.html">                          collection.coffee                      </a>                                                                  <a class="source" href="facets.html">                          facets.coffee                      </a>                                                                  <a class="source" href="index.html">                          index.coffee                      </a>                                                                  <a class="source" href="facetArray.html">                          facetArray.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="print.html">                          print.coffee                      </a>                                                                  <a class="source" href="routes.html">                          routes.coffee                      </a>                                                                  <a class="source" href="facet.html">                          facet.coffee                      </a>                                                                  <a class="source" href="item.html">                          item.coffee                      </a>                                                                  <a class="source" href="profile.html">                          profile.coffee                      </a>                                                                  <a class="source" href="cube.html">                          cube.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="code.html">                          code.coffee                      </a>                                                                  <a class="source" href="server.config.html">                          server.config.coffee                      </a>                                                                  <a class="source" href="server.routes.html">                          server.routes.coffee                      </a>                                                                  <a class="source" href="server.settings.html">                          server.settings.coffee                      </a>                                                                  <a class="source" href="entityController.html">                          entityController.coffee                      </a>                                                                  <a class="source" href="extensionController.html">                          extensionController.coffee                      </a>                                                                  <a class="source" href="facetManager.html">                          facetManager.coffee                      </a>                                                                  <a class="source" href="itemController.html">                          itemController.coffee                      </a>                                                                  <a class="source" href="printController.html">                          printController.coffee                      </a>                                                                  <a class="source" href="schema.html">                          schema.coffee                      </a>                                                                  <a class="source" href="solrManager.html">                          solrManager.coffee                      </a>                                                                  <a class="source" href="genSchema.html">                          genSchema.coffee                      </a>                                                                  <a class="source" href="importer-fortunes.html">                          importer-fortunes.coffee                      </a>                                                                  <a class="source" href="importer-hosts.html">                          importer-hosts.coffee                      </a>                                                                  <a class="source" href="importer-projects.html">                          importer-projects.coffee                      </a>                                        </div>              </div>                    <table cellpadding="0" cellspacing="0">              <thead>                  <tr>                      <th class="docs">                          <h1>                              entityController.coffee                          </h1>                      </th>                      <th class="code">                      </th>                  </tr>              </thead>              <tbody>                                                      <tr id="section-1">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-1">&#182;</a>                          </div>                          <h1 id="">#</h1>

<p>EntityController.coffee</p>

<p>@author: Emanuel Lauria <a href="m&#x61;&#x69;l&#x74;&#x6F;:&#101;&#x6D;&#x61;&#x6E;&#117;&#101;&#108;&#x2E;&#108;&#97;&#x75;&#114;&#105;&#x61;&#64;&#x7A;&#97;&#108;&#97;&#110;&#100;&#x6F;&#x2E;&#100;&#x65;">&#101;&#x6D;&#x61;&#x6E;&#117;&#101;&#108;&#x2E;&#108;&#97;&#x75;&#114;&#105;&#x61;&#64;&#x7A;&#97;&#108;&#97;&#110;&#100;&#x6F;&#x2E;&#100;&#x65;</a></p>

<h1 id="">#</h1>                      </td>                      <td class="code">                          <div class="highlight"><pre><span class="nv">fs      = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span>
<span class="nv">async   = </span><span class="nx">require</span> <span class="s">&#39;async&#39;</span>
<span class="nv">js2xml  = </span><span class="nx">require</span> <span class="s">&quot;data2xml&quot;</span>
<span class="nv">_       = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nv">mime    = </span><span class="nx">require</span> <span class="s">&quot;mime-magic&quot;</span>
<span class="nv">im      = </span><span class="nx">require</span> <span class="s">&quot;imagemagick&quot;</span>

<span class="nv">FacetManager = </span><span class="nx">require</span> <span class="s">&#39;./facetManager.coffee&#39;</span>
<span class="nv">facetManager = </span><span class="k">new</span> <span class="nx">FacetManager</span>

<span class="nv">SolrManager = </span><span class="nx">require</span> <span class="s">&#39;./solrManager.coffee&#39;</span>
<span class="nv">solrManager = </span><span class="k">new</span> <span class="nx">SolrManager</span>

<span class="nv">Schema = </span><span class="nx">require</span> <span class="s">&#39;./schema&#39;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-2">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-2">&#182;</a>                          </div>                          <p>Server and default extension settings</p>                      </td>                      <td class="code">                          <div class="highlight"><pre><span class="nv">settings = </span><span class="nx">require</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../server.settings.coffee&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-3">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-3">&#182;</a>                          </div>                          <p>List of entities</p>                      </td>                      <td class="code">                          <div class="highlight"><pre><span class="nv">entities = </span><span class="nx">require</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../entities.json&quot;</span>

<span class="k">class</span> <span class="nx">EntityController</span>

    <span class="nv">module.exports = </span><span class="nx">EntityController</span>

    <span class="nv">constructor: </span><span class="nf">(app) -&gt;</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span>   <span class="s">&#39;/:entity/schema&#39;</span><span class="p">,</span>          <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@schema</span>     <span class="nx">a</span><span class="p">...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span>   <span class="s">&#39;/:entity/settings&#39;</span><span class="p">,</span>        <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@settings</span>   <span class="nx">a</span><span class="p">...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span>   <span class="s">&#39;/:entity/collection&#39;</span><span class="p">,</span>      <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@collection</span> <span class="nx">a</span><span class="p">...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span>   <span class="s">&#39;/:entity/pane.json&#39;</span><span class="p">,</span>       <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@pane</span>       <span class="nx">a</span><span class="p">...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span>   <span class="s">&#39;/:entity/etiquettes.json&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@etiquettes</span> <span class="nx">a</span><span class="p">...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span>   <span class="s">&#39;/:entity/ufacets&#39;</span><span class="p">,</span>         <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@ufacets</span>    <span class="nx">a</span><span class="p">...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">post</span>  <span class="s">&#39;/:entity/picture&#39;</span><span class="p">,</span>         <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@picture</span>    <span class="nx">a</span><span class="p">...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span>   <span class="s">&#39;/:entity/extensions&#39;</span><span class="p">,</span>      <span class="p">(</span><span class="nx">a</span><span class="p">...)</span> <span class="o">=&gt;</span> <span class="nx">@extension</span>  <span class="nx">a</span><span class="p">...</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-4">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-4">&#182;</a>                          </div>                          <p>Return appropriate schema for each entity</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">schema: </span><span class="nf">(req, res) -&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span> <span class="k">if</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">schema = </span><span class="nx">require</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/schema.json&quot;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">schema</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-5">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-5">&#182;</a>                          </div>                          <p>Return appropriate settings for each entity</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">settings: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span> <span class="k">if</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">@getSettings</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@getEntities</span> <span class="nf">() -&gt;</span>
                <span class="nv">settings.entities = </span><span class="nx">entities</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">settings</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-6">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-6">&#182;</a>                          </div>                          <p>Return a collection based on the filter parameters.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">collection: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">404</span> <span class="nx">unless</span> <span class="nx">@isEntity</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
        <span class="nx">@createQuery</span> <span class="nx">req</span><span class="p">,</span> <span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">query = </span><span class="nx">@setFilters</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">query</span>
            <span class="nx">@getCollection</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">@setCollectionResponse</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">result</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-7">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-7">&#182;</a>                          </div>                          <p>Returns extension code. i.e. newbies feature on team app.
WARN This route is being used by third party apps!</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">pane: </span><span class="nf">(req, res) -&gt;</span>
        <span class="nv">file = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../extensions/</span><span class="si">#{</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span><span class="si">}</span><span class="s">/pane.json&quot;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;application/json&#39;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span> <span class="s">&quot;utf8&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="p">{}</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data</span>

    <span class="nv">etiquettes: </span><span class="nf">(req, res) -&gt;</span>
        <span class="nv">file = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../extensions/</span><span class="si">#{</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span><span class="si">}</span><span class="s">/etiquettes.json&quot;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;application/json&#39;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span> <span class="s">&quot;utf8&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="p">{}</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-8">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-8">&#182;</a>                          </div>                          <p>Get unique values from all the facet fields. Useful for autocomplete.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">ufacets: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">facetManager</span><span class="p">.</span><span class="nx">distincts</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">d</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-9">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-9">&#182;</a>                          </div>                          <p>Picture uploader. Save picture on tmp location, convert, manipulate and
move to storage location. Respond with an array of properties from the
uploaded image. Useful for backbone.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">picture: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span>
        <span class="nv">upload_id = </span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">picture</span><span class="p">.</span><span class="nx">path</span>
        <span class="nv">target_filename = </span><span class="nx">upload_id</span> <span class="o">+</span> <span class="s">&#39;.jpg&#39;</span>
        <span class="nv">target_path= </span><span class="s">&quot;public/images/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/archive/&quot;</span>
        <span class="nv">target_file = </span><span class="nx">target_path</span> <span class="o">+</span> <span class="nx">target_filename</span>
        <span class="nv">tmp_file = </span><span class="s">&#39;public/images/tmp/&#39;</span> <span class="o">+</span> <span class="nx">target_filename</span>
        <span class="nv">url_file = </span><span class="s">&quot;/images/tmp/&quot;</span> <span class="o">+</span> <span class="nx">target_filename</span>
        <span class="nv">response = </span><span class="p">[</span> <span class="nv">name: </span><span class="nx">target_filename</span><span class="p">,</span> <span class="nv">url: </span><span class="nx">url_file</span> <span class="p">]</span>
        <span class="nv">im_params = </span> <span class="p">[</span>
            <span class="s">&quot;</span><span class="si">#{</span><span class="nx">target_file</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&#39;-thumbnail&#39;</span><span class="p">,</span> <span class="s">&#39;300x300^&#39;</span><span class="p">,</span> <span class="s">&#39;-gravity&#39;</span><span class="p">,</span> <span class="s">&#39;center&#39;</span><span class="p">,</span>
            <span class="s">&#39;-extent&#39;</span><span class="p">,</span> <span class="s">&#39;300x300&#39;</span><span class="p">,</span> <span class="s">&#39;public/images/tmp/&#39;</span> <span class="o">+</span> <span class="nx">target_filename</span>
        <span class="p">]</span>

        <span class="nx">mime</span> <span class="nx">upload_id</span><span class="p">,</span> <span class="nf">(err, type) -&gt;</span>
            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">response</span><span class="p">.</span><span class="nx">push</span> <span class="nv">type: </span><span class="nx">type</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">rename</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../</span><span class="si">#{</span><span class="nx">upload_id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">target_file</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
                <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                <span class="nx">im</span><span class="p">.</span><span class="nx">convert</span> <span class="nx">im_params</span><span class="p">,</span> <span class="nf">(err, stdout, stderr) -&gt;</span>
                    <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                    <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">tmp_file</span><span class="p">,</span> <span class="nf">(err, stats) -&gt;</span>
                        <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                        <span class="nx">response</span><span class="p">.</span><span class="nx">push</span> <span class="nv">size: </span><span class="nx">stats</span><span class="p">.</span><span class="nx">size</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">response</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-10">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-10">&#182;</a>                          </div>                          <p>Return templates from an extension</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">extension: </span><span class="nf">(req, res) -&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span> <span class="s">&quot;extensions/</span><span class="si">#{</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span><span class="si">}</span><span class="s">/templates&quot;</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-11">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-11">&#182;</a>                          </div>                          <p>Run query and return either CSV, JSON or XML</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">getCollection: </span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">search</span> <span class="nx">query</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">docs = </span><span class="p">[]</span>
            <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">docs</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">result</span> <span class="o">and</span> <span class="nx">result</span><span class="p">.</span><span class="nx">response</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">result</span><span class="p">.</span><span class="nx">response</span><span class="o">?</span><span class="p">.</span><span class="nx">docs</span><span class="p">,</span> <span class="nf">(doc) -&gt;</span>
                <span class="nx">docs</span><span class="p">.</span><span class="nx">push</span> <span class="nx">solrManager</span><span class="p">.</span><span class="nx">removeSuffix</span> <span class="nx">doc</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">response</span><span class="o">?</span><span class="p">.</span><span class="nv">docs = </span><span class="nx">docs</span>
            <span class="nx">cb</span> <span class="nx">result</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-12">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-12">&#182;</a>                          </div>                          <p>Return all available entities with its settings</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">getEntities: </span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">es = </span><span class="p">{}</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../entities.json&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nv">entities = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">e</span>
            <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">entities</span><span class="p">,</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@getSettings</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span>
                    <span class="nx">es</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span>
                    <span class="nx">cb</span><span class="p">()</span>
            <span class="p">,</span> <span class="nf">(err) -&gt;</span>
                <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
                <span class="k">return</span> <span class="nx">cb</span> <span class="nx">es</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-13">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-13">&#182;</a>                          </div>                          <p>Read settings file from extension and return it as JSON object</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">getSettings: </span><span class="p">(</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">settingsFile = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../extensions/</span><span class="si">#{</span><span class="nx">entity</span><span class="si">}</span><span class="s">/settings.json&quot;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">settingsFile</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">throw</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">cb</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-14">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-14">&#182;</a>                          </div>                          <p>Get the sort parameter. If its not specified on QS, the default value
is specified in the settings file.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">getSort: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span>
        <span class="nx">@getSettings</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">sort = </span><span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">sort</span> <span class="k">then</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">sort</span> <span class="k">else</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">sort</span>
            <span class="p">[</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">order</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">sort</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;:&#39;</span>
            <span class="k">if</span> <span class="nx">sort</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">3</span>
                <span class="p">[</span><span class="nx">id1</span><span class="p">,</span> <span class="nx">id2</span><span class="p">,</span> <span class="nx">order</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sort</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;:&#39;</span>
                <span class="nv">id = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">id1</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">id2</span><span class="si">}</span><span class="s">&quot;</span>
            <span class="nv">field = </span><span class="nx">solrManager</span><span class="p">.</span><span class="nx">getFieldFromSchema</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">id</span>
            <span class="k">if</span> <span class="nx">@isMultivalue</span> <span class="nx">field</span> <span class="k">then</span> <span class="nv">id = </span><span class="s">&quot;sort_</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">-s&quot;</span>
            <span class="k">else</span> <span class="nv">id = </span><span class="nx">solrManager</span><span class="p">.</span><span class="nx">addSuffix</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">id</span>
            <span class="nv">sort = </span><span class="p">{}</span>
            <span class="nx">sort</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">order</span>
            <span class="nx">cb</span> <span class="nx">sort</span>

    <span class="nv">createQuery: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span>
        <span class="nx">@getSettings</span> <span class="nx">name</span><span class="p">,</span> <span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nv">q = </span><span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">q</span> <span class="k">then</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">q</span><span class="si">}</span><span class="s">*&quot;</span> <span class="k">else</span> <span class="s">&quot;*:*&quot;</span>
            <span class="nv">rows = </span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">rows</span> <span class="o">or</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">rows</span>
            <span class="nv">start = </span><span class="nx">rows</span><span class="o">*</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">page</span> <span class="o">||</span> <span class="mi">0</span>
            <span class="nx">@getSort</span> <span class="nx">req</span><span class="p">,</span> <span class="p">(</span><span class="nx">sort</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nv">solrManager = </span><span class="k">new</span> <span class="nx">SolrManager</span> <span class="nx">name</span>
                <span class="nv">db = </span><span class="nx">solrManager</span><span class="p">.</span><span class="nx">createClient</span><span class="p">()</span>
                <span class="nv">query = </span><span class="nx">db</span><span class="p">.</span><span class="nx">createQuery</span><span class="p">()</span>
                    <span class="p">.</span><span class="nx">q</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sort</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">defType</span><span class="p">(</span><span class="s">&quot;edismax&quot;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">pf</span><span class="p">(</span><span class="nx">@getSearchableFields</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">qf</span><span class="p">(</span><span class="nx">@getSearchableFields</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">rows</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">facet</span> <span class="kc">on</span><span class="o">:</span> <span class="kc">yes</span><span class="p">,</span> <span class="nv">missing: </span><span class="kc">yes</span><span class="p">,</span> <span class="nv">mincount: </span><span class="mi">1</span>
                <span class="nx">cb</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">db</span>

    <span class="nv">setCollectionResponse: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">csv</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain; charset=utf8&#39;</span>
            <span class="nv">result = </span><span class="nx">@toCSV</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">result</span>

        <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">xml</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/xml&#39;</span>
            <span class="nv">result = </span><span class="nx">js2xml</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="nx">result</span>

        <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">json</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;application/json&#39;</span>
            <span class="nv">result = </span><span class="nx">result</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">docs</span>
        <span class="nx">result</span>

    <span class="nv">setFilters: </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">name = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">entity</span>
        <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s">&quot;facet.field&quot;</span><span class="p">]</span>
            <span class="nv">ff = </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s">&quot;facet.field&quot;</span><span class="p">]</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-15">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-15">&#182;</a>                          </div>                          <p>FIXME Incapable of handling only 1 facet.</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">ff</span> <span class="o">isnt</span> <span class="k">typeof</span> <span class="p">[]</span>
                <span class="nv">ff = </span><span class="p">[</span> <span class="nx">ff</span> <span class="p">]</span>
            <span class="nv">fields = </span><span class="p">[]</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">ff</span><span class="p">,</span> <span class="nf">(f) -&gt;</span>
                <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span> <span class="nx">solrManager</span><span class="p">.</span><span class="nx">addSuffix</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">f</span>
            <span class="nx">query</span><span class="p">.</span><span class="nx">facet</span> <span class="nv">field: </span><span class="nx">fields</span>

        <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">fs</span>
            <span class="nv">fqFields = </span><span class="p">{}</span>
            <span class="nv">fq = </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">fs</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-16">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-16">&#182;</a>                          </div>                          <p>Handle an array of facet filters</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">fq</span> <span class="o">is</span> <span class="k">typeof</span> <span class="p">[]</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">fq</span><span class="p">,</span> <span class="nf">(fq) -&gt;</span>
                    <span class="nv">f = </span><span class="nx">fq</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                    <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">solrManager</span><span class="p">.</span><span class="nx">addSuffix</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-17">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-17">&#182;</a>                          </div>                          <p>If no value, use it to exclude field</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>                    <span class="nv">f = </span><span class="p">[</span> <span class="s">&quot;-</span><span class="si">#{</span><span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&#39;[&quot;&quot; TO *]&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;&#39;</span>

                    <span class="nx">fqFields</span><span class="p">[</span><span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">fqFields</span><span class="p">[</span><span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="nx">fqFields</span><span class="p">[</span><span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="nx">push</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">fqFields</span><span class="p">,</span> <span class="nf">(fields, f) -&gt;</span>
                    <span class="nx">query</span><span class="p">.</span><span class="nx">matchFilter</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">fields</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-18">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-18">&#182;</a>                          </div>                          <p>Handle just one facet filter</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">fq</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
                <span class="nv">f = </span><span class="nx">fq</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">solrManager</span><span class="p">.</span><span class="nx">addSuffix</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nv">f = </span><span class="p">[</span> <span class="s">&quot;-</span><span class="si">#{</span><span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&#39;[&quot;&quot; TO *]&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;&#39;</span>

                <span class="nx">query</span><span class="p">.</span><span class="nx">matchFilter</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="nx">query</span>

    <span class="nv">getSearchableFields: </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">schema = </span><span class="k">new</span> <span class="nx">Schema</span> <span class="nx">name</span>
        <span class="nv">searchables = </span><span class="nx">schema</span><span class="p">.</span><span class="nx">getSearchables</span><span class="p">()</span>
        <span class="nv">fields = </span><span class="p">[]</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">searchables</span><span class="p">,</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">return</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;sort_</span><span class="si">#{</span><span class="nx">f</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">-s&quot;</span> <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">multivalue</span>
            <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span> <span class="nx">solrManager</span><span class="p">.</span><span class="nx">addSuffix</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">search</span>
        <span class="k">return</span> <span class="nx">fields</span>

    <span class="nv">isEntity: </span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="kc">yes</span> <span class="nx">unless</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="kc">no</span>

    <span class="nv">isMultivalue: </span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">field</span><span class="p">.</span><span class="nx">multivalue</span>
        <span class="k">return</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">field</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;facet&#39;</span> <span class="o">or</span> <span class="nx">field</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;tuple&#39;</span>
        <span class="k">return</span> <span class="kc">no</span></pre></div>                      </td>                  </tr>                                                      <tr id="section-19">                      <td class="docs">                          <div class="pilwrap">                              <a class="pilcrow" href="#section-19">&#182;</a>                          </div>                          <p>Parse an item and form a ';' separated string with its values</p>                      </td>                      <td class="code">                          <div class="highlight"><pre>    <span class="nv">toCSV: </span><span class="nf">(name, res) -&gt;</span>
        <span class="nv">schema = </span><span class="nx">require</span> <span class="s">&quot;../extensions/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">/schema.json&quot;</span>
        <span class="nv">output = </span><span class="p">[]</span>
        <span class="nv">fields = </span><span class="p">[]</span>
        <span class="nv">headers = </span><span class="p">[]</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">schema</span><span class="p">,</span> <span class="nf">(f) -&gt;</span>
            <span class="nx">headers</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span><span class="p">.</span><span class="nx">id</span>
            <span class="nx">fields</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span><span class="p">.</span><span class="nx">id</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">headers</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;;&#39;</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">res</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">docs</span><span class="p">,</span> <span class="nf">(doc) -&gt;</span>
            <span class="nv">line = </span><span class="p">[]</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">fields</span><span class="p">,</span> <span class="nf">(f) -&gt;</span>
                <span class="nx">line</span><span class="p">.</span><span class="nx">push</span> <span class="nx">doc</span><span class="p">[</span><span class="nx">f</span><span class="p">]</span>
            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">line</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;;&#39;</span>

        <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span>

</pre></div>                      </td>                  </tr>                                </tbody>          </table>      </div>  </body>  </html>